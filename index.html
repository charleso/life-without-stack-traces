<!DOCTYPE html>
<html>
  <head>
    <title>Life Without Stack Traces</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
    /* latin-ext */
      @font-face {
        font-family: 'Yanone Kaffeesatz';
        font-style: normal;
        font-weight: 400;
        src: local('Yanone Kaffeesatz Regular'), local('YanoneKaffeesatz-Regular'), url(fonts/YDAoLskQQ5MOAgvHUQCcLaa0P60JZGaCMFbL3N9v4H0.woff2) format('woff2');
        unicode-range: U+0100-024F, U+1E00-1EFF, U+20A0-20AB, U+20AD-20CF, U+2C60-2C7F, U+A720-A7FF;
      }
      /* latin */
      @font-face {
        font-family: 'Yanone Kaffeesatz';
        font-style: normal;
        font-weight: 400;
        src: local('Yanone Kaffeesatz Regular'), local('YanoneKaffeesatz-Regular'), url(fonts/YDAoLskQQ5MOAgvHUQCcLWjF_m7mVnhXExjNED3rUtY.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
      }

      /* latin */
      @font-face {
        font-family: 'Droid Serif';
        font-style: normal;
        font-weight: 400;
        src: local('Droid Serif'), local('DroidSerif'), url(fonts/0AKsP294HTD-nvJgucYTaIgp9Q8gbYrhqGlRav_IXfk.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
      }
      /* latin */
      @font-face {
        font-family: 'Droid Serif';
        font-style: normal;
        font-weight: 700;
        src: local('Droid Serif Bold'), local('DroidSerif-Bold'), url(fonts/QQt14e8dY39u-eYBZmppwf79_ZuUxCigM2DespTnFaw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
      }
      /* latin */
      @font-face {
        font-family: 'Droid Serif';
        font-style: italic;
        font-weight: 400;
        src: local('Droid Serif Italic'), local('DroidSerif-Italic'), url(fonts/cj2hUnSRBhwmSPr9kS589weOulFbQKHxPa89BaxZzA0.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
      }
      @font-face {
        font-family: 'Ubuntu Mono';
        font-style: normal;
        font-weight: 700;
        src: local('Ubuntu Mono Bold'), local('UbuntuMono-Bold'), url(fonts/ceqTZGKHipo8pJj4molytv79_ZuUxCigM2DespTnFaw.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
      }
      @font-face {
        font-family: 'Ubuntu Mono';
        font-style: normal;
        font-weight: 400;
        src: local('Ubuntu Mono'), local('UbuntuMono-Regular'), url(fonts/ViZhet7Ak-LRXZMXzuAfkYgp9Q8gbYrhqGlRav_IXfk.woff2) format('woff2');
        unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
      }

      body {
        font-family: Futura, 'Yanone Kaffeesatz';
      }
      li {
        font-size: 30px;
        padding-top: 20px;
      }
      .remark-code {
        font-size: 30px;
      }
      h1, h2, h3 {
        font-weight: normal;
      }
      .inverse {
        background: #4795c6;
        color: white;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
      }
      .relative h1 {
        position: relative !important;
      }
      .question {
        background: #76b242;
        color: white;
      }
      .rule {
        background: #ee2a24;
        color: white;
      }
      .boom {
      }
      .error {
        color: #ee2a24;
        font-size: 30px;
      }
      .image {
        padding: 0px;
        color: white;
        background-color: black;

        position: relative;
      }
      .image img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        /*height: 100%;*/
        float: left;
      }
      .image h1, .image h2 {
        position: absolute;
        bottom: 0;
        text-align: center;
        left: 20px;
      }
      .image-white {
        color: black;
        background-color: white;
      }
      .image-last h1 {
        right: 0;
        bottom: 100px;
      }
      .remark-code, .remark-inline-code {
        font-family: 'Ubuntu Mono';
      }
      .remark-slide-content {
        padding: 10px 10px 10px 30px;
      }
      .hljs-default .hljs {
        background-color: transparent;
        padding: 0px !important;
      }
      .ambiata-full {
        background-image: url(images/ambiata_avatar.png);
      }
      .evolution {
        background-color: #DEDEDE;
      }
      .evolution h1 {
        color: black !important;
      }
      .top h1 {
        top: 0px;
      }
      .toc {
         color: #777;
         margin-top: 135px;
      }
      .toc-selected {
         color: #000;
      }
      /*
      .ambiata-full h2 {
        position: absolute;
        bottom: 0;
        right: 0;
      }
      */
      .ambiata {
        background-image: url(images/ambiata_avatar.png);
        background-position: top right;
        background-size: 100px;
        /*-webkit-filter: grayscale(40%);*/
      }
      .code-small .remark-code {
        font-size: 20px;
      }
      .remark-container {
        height: 100%;
        width: 100%;
      }
      .remark-slide-number {
        display: none;
      }
      .trace-example {
        margin-top: 12px;
      }
      .trace-example .trace-useful {
        color: red;
      }
      .trace-example pre {
        font-size: 12px;
        padding: 0px;
        margin: 0px;
      }
      .red span {
        color: red;
      }
    </style>
  </head>
  <body>

    <textarea id="source">
name: image
layout: true
class: center, middle, image

---
name: image-white
layout: true
class: center, middle, image, image-white

---
name: image-last
layout: true
class: center, middle, image, image-last

---
name: ambiata
layout: true
class: ambiata

---
name: ambiata-full
layout: true
class: center, middle, ambiata-full

---
name: code-small
layout: true
class: code-small

---
name: question
layout: true
class: center, middle, question

---
name: rule
layout: true
class: center, middle, rule

---
name: boom
layout: true
class: boom

---
name: inverse
layout: true
class: center, middle, inverse

---

class: center, middle
template: image

# Life Without Stack Traces

---

layout: false
template: image

<img src="images/chopsticks.jpg" />

# Charles O'Farrell












---

template: image

<img src="http://www.cronulla.anglican.asn.au/wp-content/uploads/in-beginning.jpg">

---

layout: false

## Exception

```java
java.lang.NullPointerException
  at com.example.MyService.list(MyService.java:23)
  at com.example.MyController.list(MyController.java:11)
```

---

<img height="600px" src="https://camo.githubusercontent.com/88444f193d394e1003e4577afcb636e1768263b7/687474703a2f2f692e696d6775722e636f6d2f6a61636f6a2e6a7067" />

---

template: question

## What it really looks like...

---

<pre style="font-size: 12px;">
java.lang.NullPointerException
  at com.example.MyService.list(MyService.java:23)
  at net.sf.cglib.proxy.MethodProxy.invoke()
  at org.springframework.aop.framework.Cglib2AopProxy$CglibMethodInvocation.invokeJoinpoint()
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()
  at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed()
  at com.blogspot.nurkiewicz.LoggingAspect.logging()
  at sun.reflect.NativeMethodAccessorImpl.invoke0()
  at sun.reflect.NativeMethodAccessorImpl.invoke()
  at sun.reflect.DelegatingMethodAccessorImpl.invoke()
  at java.lang.reflect.Method.invoke()
  at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs()
  at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod()
  at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke()
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()
  at org.springframework.aop.interceptor.AbstractTraceInterceptor.invoke()
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()
  at org.springframework.transaction.interceptor.TransactionInterceptor.invoke()
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()
  at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke()
  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()
  at org.springframework.aop.framework.Cglib2AopProxy$DynamicAdvisedInterceptor.intercept()
  at com.example.MyController.list(MyController.java:11)
  at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)
  at com.example.myproject.ExceptionHandlerFilter.doFilter(ExceptionHandlerFilter.java:28)
  at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)
  at com.example.myproject.OutputBufferFilter.doFilter(OutputBufferFilter.java:33)
  at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)
  at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:388)
  at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)
  at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)
  at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:765)
  at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:418)
  at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)
  at org.mortbay.jetty.Server.handle(Server.java:326)
  at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)
  at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:943)
  at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:756)
  at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:218)
  at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)
  at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)
  at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)
</pre>

---

<div class="trace-example">
<pre>java.lang.NullPointerException</pre>
<pre class="trace-useful">  at com.example.MyService.list(MyService.java:23)</pre>
<pre>  at net.sf.cglib.proxy.MethodProxy.invoke()</pre>
<pre>  at org.springframework.aop.framework.Cglib2AopProxy$CglibMethodInvocation.invokeJoinpoint()</pre>
<pre>  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()</pre>
<pre>  at org.springframework.aop.aspectj.MethodInvocationProceedingJoinPoint.proceed()</pre>
<pre>  at com.blogspot.nurkiewicz.LoggingAspect.logging()</pre>
<pre>  at sun.reflect.NativeMethodAccessorImpl.invoke0()</pre>
<pre>  at sun.reflect.NativeMethodAccessorImpl.invoke()</pre>
<pre>  at sun.reflect.DelegatingMethodAccessorImpl.invoke()</pre>
<pre>  at java.lang.reflect.Method.invoke()</pre>
<pre>  at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethodWithGivenArgs()</pre>
<pre>  at org.springframework.aop.aspectj.AbstractAspectJAdvice.invokeAdviceMethod()</pre>
<pre>  at org.springframework.aop.aspectj.AspectJAroundAdvice.invoke()</pre>
<pre>  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()</pre>
<pre>  at org.springframework.aop.interceptor.AbstractTraceInterceptor.invoke()</pre>
<pre>  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()</pre>
<pre>  at org.springframework.transaction.interceptor.TransactionInterceptor.invoke()</pre>
<pre>  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()</pre>
<pre>  at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke()</pre>
<pre>  at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed()</pre>
<pre>  at org.springframework.aop.framework.Cglib2AopProxy$DynamicAdvisedInterceptor.intercept()</pre>
<pre class="trace-useful">  at com.example.MyController.list(MyController.java:11)</pre>
<pre>  at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)</pre>
<pre>  at com.example.myproject.ExceptionHandlerFilter.doFilter(ExceptionHandlerFilter.java:28)</pre>
<pre>  at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)</pre>
<pre>  at com.example.myproject.OutputBufferFilter.doFilter(OutputBufferFilter.java:33)</pre>
<pre>  at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1157)</pre>
<pre>  at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:388)</pre>
<pre>  at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)</pre>
<pre>  at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)</pre>
<pre>  at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:765)</pre>
<pre>  at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:418)</pre>
<pre>  at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)</pre>
<pre>  at org.mortbay.jetty.Server.handle(Server.java:326)</pre>
<pre>  at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)</pre>
<pre>  at org.mortbay.jetty.HttpConnection$RequestHandler.content(HttpConnection.java:943)</pre>
<pre>  at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:756)</pre>
<pre>  at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:218)</pre>
<pre>  at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)</pre>
<pre>  at org.mortbay.jetty.bio.SocketConnector$Connection.run(SocketConnector.java:228)</pre>
<pre>  at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)    </pre>
</div>

???

- Side note: we might like to know what the values at those functions calls were

---

## Real world

```scala
def run(a: Auth, u: UserId): Future[User] =
  for {
    s &lt;- login(c)
    b &lt;- load(s, u)
  } yield b
```

---

## Boom

```scala
def run(a: Auth, u: UserId): Future[User] =
  for {
    s &lt;- login(c)
    b &lt;- load(s, u)
  } yield b
```

<br/>

<pre style="font-size: 13px;">
Exception in thread "main" java.lang.NullPointerException
	at Example.load(Example.scala:17)
	at Example$$anonfun$bar$1.apply$mcI$sp(Example.scala:17)
	at Example$$anonfun$bar$1.apply(Example.scala:17)
	at Example$$anonfun$bar$1.apply(Example.scala:17)
	at scala.concurrent.impl.Future$PromiseCompletingRunnable.liftedTree1$1(Future.scala:24)
	at scala.concurrent.impl.Future$PromiseCompletingRunnable.run(Future.scala:24)
	at scala.concurrent.impl.ExecutionContextImpl$AdaptedForkJoinTask.exec(ExecutionContextImpl.scala:121)
	at scala.concurrent.forkjoin.ForkJoinTask.doExec(ForkJoinTask.java:260)
	at scala.concurrent.forkjoin.ForkJoinPool$WorkQueue.runTask(ForkJoinPool.java:1339)
	at scala.concurrent.forkjoin.ForkJoinPool.runWorker(ForkJoinPool.java:1979)
	at scala.concurrent.forkjoin.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:107)
</pre>

---

template: question

## Partial Functions


---

template: question

## Partial Functions

### "A partial function is a function that is not defined for all possible arguments of the specified type"

---

template: question

## Partial Functions

### "Functions that throw exceptions"

---

template: question

## Partial Functions

### "Functions that throw exceptions (or return null)"

---

template: question

## Partial Functions

### "Functions that aren't functions"

---

## NOT [scala.PartialFunction](http://www.scala-lang.org/api/current/index.html#scala.PartialFunction)

```scala
trait PartialFunction[A, B] extends Function[A, B] {
  def isDefinedAt(x: A): Boolean
}
```

---

template: image

<img src="http://3.bp.blogspot.com/-URKZXlSiFeg/UiIyNGa0CCI/AAAAAAAADLQ/nsCrFJ7AAUI/s1600/the-dar-50.jpg" />

---

## Is this partial?

```scala
trait Foo[A] {





  def bar: A
}
```

---

## Looks more familiar

```scala
trait Option[A] {





  def get: A
}
```

---

## Game over

```scala
trait Option[A] {

  /** Returns the option's value.
   *  @note The option must be nonEmpty.
   *  @throws java.util.NoSuchElementException
   */
  def get: A
}
```

---

## Is this partial?

```scala




def foo      (s: String, i: Int): String
```

---

## What about now?

```scala




def substring(s: String, i: Int): String
```
---

## What about now?

```scala
/**
 * @throws IndexOutOfBoundsException
 *   - if beginIndex is &lt; or &gt; than the length
 */
def substring(s: String, i: Int): String
```

---

## Is this partial?

```scala
def hello: List[String] =
  foo("hello world")
```

---

## Is this partial?

```scala
def hello: List[String] =
  foo("hello world")
```

- Depends on `foo`

---

## Is this partial?

```scala
def hello: List[String] =
  foo("hello world")
```

- Depends on `foo`
- Which depends on `bar`

---

## Is this partial?

```scala
def hello: List[String] =
  foo("hello world")
```

- Depends on `foo`
- Which depends on `bar`
- Which depends on...

---

## Is this partial?

```scala
def hello: List[String] =
  foo("hello world")
```

- Depends on `foo`
- Which depends on `bar`
- Which depends on...
- We use names (and familiarity) to detect errors
  - Doesn't scale as we compose

---

template: question

## Future Proof

---

## Today

```scala
/**
 * @throws BadException
 *
 */
def foo: Unit
```

---

## Today

```scala
/**
 * @throws BadException
 *
 */
def foo: Unit


def bar =
  try {
    foo
  } catch {
    e: BadException =>
      ...
  }
```

---

## Tomorrow

```scala
/**
 * @throws BadException
 * @throws UglyException
 */
def foo: Unit


def bar =
  try {
    foo
  } catch {
    e: BadException =>
      ...
  }
```

---

## Partial Functions

- Type signatures not enough
  - Harder to reason about
  - Harder to review
- Not future proof
  - Functions that introduce new errors
    won't require code change
- Stacktraces are not always useful
  - eg. Future

---

template: image

<img src="http://cdn2-b.examiner.com/sites/default/files/styles/image_content_width/hash/3d/f3/beach-relax_0.jpg" />

---

template: image

<img src="https://s3.amazonaws.com/rapgenius/1361797568_f_fa0a8fc348.jpg" />

## Imagine a world without errors

---

## Either

```scala
sealed trait Either[L, R]

case class Left(l: L) extends Either[L, Nothing]

case class Right(r: R) extends Either[Nothing, R]
```

---

## Either

```scala
/**
 * @throws InvalidCredentialsException
 */
def login(a: Auth): Either[Exception, Session]

/**
 * @throws UserNotFoundException
 */
def load(u: Session, u: UserId): Either[Exception, User]
```

---

## Either in action

```scala
/**
 * @throws InvalidCredentialsException
 */
def login(a: Auth): Either[Exception, Session]

/**
 * @throws UserNotFoundException
 */
def load(u: Session, u: UserId): Either[Exception, User]


def run(a: Auth, u: UserId): Either[Exception, User] =
  for {
    s &lt;- login(c).right
    b &lt;- load(s, u).right
  } yield b
```

???

- If `login()` returns an exception, stop
- If `load()` return an exception, stop
- etc

---

## Either in action (almost)

```scala
/**
 * @throws InvalidCredentialsException
 */
def login(a: Auth): Either[Exception, Session]

/**
 * @throws UserNotFoundException
 */
def load(u: Session, u: UserId): Either[Exception, User]


def run(a: Auth, u: UserId): Either[Exception, User] =
  for {
    s &lt;- login(c)
    b &lt;- load(s, u)
  } yield b
```

---

## What now?

```scala
def run(a: Auth, u: UserId): Either[Exception, User]


run(c, u) match {

  case Left(e) =>

    // Not this again...
    e.printStackTrace
}
```

---

template: question

## Data types are cheap

---

## Data

```scala







/**
 * @throws InvalidCredentialsException
 */
def login(a: Auth): Either[Exception, User]
```

---

## Data

```scala
sealed trait LoginError

case class InvalidCredentials(a: Auth) extends LoginError







def login(a: Auth): Either[LoginError, User]
```

---

## Data

```scala









/**
 * @throws UserNotFoundException
 */
def load(u: Session, u: UserId): Either[Exception, User]
```

---

## Data

```scala





sealed trait UserError

case class UserNotFound(u: UserId) extends UserError




def load(u: Session, u: UserId): Either[UserError, User]
```

---

## Data

```scala
sealed trait LoginError

case class InvalidCredentials(a: Auth) extends LoginError


sealed trait UserError

case class UserNotFound(u: UserId) extends UserError


def login(a: Auth): Either[LoginError, User]

def load(u: Session, u: UserId): Either[UserError, User]
```

---

## Hmmm

```scala
sealed trait LoginError




sealed trait UserError




def run(a: Auth, u: UserId): Either[???, User] =
  for {
    s &lt;- login(c)
    b &lt;- load(s, u)
  } yield b
```

---

## Back where we started

```scala
sealed abstract class LoginError extends Exception




sealed abstract class UserError extends Exception




def run(a: Auth, u: UserId): Either[Exception, User] =
  for {
    s &lt;- login(c)
    b &lt;- load(s, u)
  } yield b
```

---

template: question

## Data types are cheap

---

## Data types are cheap

```scala



sealed trait AppError

case class AppLoginError(e: LoginError) extends AppError

case class AppUserError(e: UserError) extends AppError
```

???

- Explain sealed trait

---

## Types FTW

```scala
def run(a: Auth, u: UserId): Either[AppError, User]


sealed trait AppError

case class AppLoginError(e: LoginError) extends AppError

case class AppUserError(e: UserError) extends AppError
```

---

## Update error

```scala
def run(a: Auth, u: UserId): Either[AppError, User] =
  for {
    s &lt;- login(c).updateError(AppLoginError(_))
    b &lt;- load(s, u).updateError(AppUserError(_))
  } yield b
```

---

## Update error

```scala
def run(a: Auth, u: UserId): Either[AppError, User] =
  for {
    s &lt;- login(c).updateError(AppLoginError(_))
    b &lt;- load(s, u).updateError(AppUserError(_))
  } yield b


trait Either[L, R] {

  def updateError[L2](f: L => L2): Either[L2, R] =
    this match {
      Left(l) => Left(f(l))
      Right(r) => Right(r)
    }
```

---

## Now when we call...

```scala
run(c, u)
```

---

## ...we have to do _something_

```scala
run(c, u) match {
  case Left(e) =>
    e match {

      case AppLoginError(InvalidCredentials(_)) =>
        ...

      case AppUserError(UserNotFound(_)) =>
        ...
    }
}
```

---

## Print details

```scala
def render(e: AppError): String =

    e match {

      case AppLoginError(InvalidCredentials(c)) =>
        s"Error on login: ${c.username}"

      case AppUserError(UserNotFound(u)) =>
         s"Could not find user: ${u.id}"
}
```

---

## Exit status

```scala
def loadErrorStatusCode(e: AppError): HttpStatus =

    e match {

      case AppLoginError(InvalidCredentials(_)) =>
         notFound403

      case AppUserError(UserNotFound(_)) =>
         notFound404
}
```

---

## Errors as data

- Error messages
- Logging
- HTTP status codes
- Executable exit codes
- JSON serialisation
- ...

---

template: question

# Future proof

---

## So far so good

```scala
sealed trait AppError

...


run(c, u) match {
  case Left(e) =>
    e match {
      case AppLoginError(InvalidCredentials(_)) => ...
      case AppUserError(UserNotFound(_)) => ...
    }
}
```

---

## Please sir

```scala
sealed trait AppError

case class AppFooError() extends AppError


run(c, u) match {
  case Left(e) =>
    e match {
      case AppLoginError(InvalidCredentials(_)) => ...
      case AppUserError(UserNotFound(_)) => ...
    }
}
```

---

## Compile warnings

```scala
sealed trait AppError

case class AppFooError() extends AppError


run(c, u) match {
  case Left(e) =>
    e match {
      case AppLoginError(InvalidCredentials(_)) => ...
      case AppUserError(UserNotFound(_)) => ...
    }
}
```

<pre><code class="remark-code"><div><span style="color: #DDDD00">[warn]</span> match may not be exhaustive.</div><div><span style="color: #DDDD00">[warn]</span> It would fail on the following input: AppFooError(_)</div><div><span style="color: #DDDD00">[warn]</span>     run(c, u) match {</div><div><span style="color: #DDDD00">[warn]</span>         ^</div>
</code></pre>

???

- Mention `sealed trait` again

---

## Warnings as errors

```scala
sealed trait AppError

case class AppFooError() extends AppError


run(c, u) match {
  case Left(e) =>
    e match {
      case AppLoginError(InvalidCredentials(_)) => ...
      case AppUserError(UserNotFound(_)) => ...
    }
}
```

```scala
scalacOptions in Compile ++= Seq("-Xfatal-warnings")
```

---

## Compile errors

```scala
sealed trait AppError

case class AppFooError() extends AppError


run(c, u) match {
  case Left(e) =>
    e match {
      case AppLoginError(InvalidCredentials(_)) => ...
      case AppUserError(UserNotFound(_)) => ...
    }
}
```

<pre><code class="remark-code"><div><span style="color: red">[error]</span> match may not be exhaustive.</div><div><span style="color: red">[error]</span> It would fail on the following input: AppFooError(_)</div><div><span style="color: red">[error]</span>     run(c, u) match {</div><div><span style="color: red">[error]</span>         ^</div>
</code></pre>

---

template: question

# Add more context

---

## Previously

```scala
case class AppUserError(e: UserError)
  extends AppError

def run(a: Auth, u: UserId): Either[AppError, User] =
  for {
    s &lt;- login(c).updateError(AppLoginError(_))
    b &lt;- load(s, u)
      .updateError(AppUserError(_))
  } yield b
```

---

## Add context

```scala
case class AppUserError(e: UserError, u: Username)
  extends AppError

def run(a: Auth, u: UserId): Either[AppError, User] =
  for {
    s &lt;- login(c).updateError(AppLoginError(_))
    b &lt;- load(s, u)
      .updateError(AppUserError(_, a.username))
  } yield b
```

---

## Errors as data

- Types as documentation
- Force consumers to deal with them
- Can have different failure cases
  depending on the consumer
- Contain all the information you need to debug
  - "Logical stacktrace"
- Future proof
  - Will fail when error cases change










---
template: image

<img height="100%" src="http://previews.123rf.com/images/endhals/endhals1105/endhals110500113/9547427-Teddy-Bear-buckled-with-safety-belt-in-a-car-Stock-Photo-seat.jpg" />

## Buckle up

---

## So far

```scala
def login(a: Auth): Either[LoginError, Session]

def load(u: Session, u: UserId):
  Either[UserError, User]
```

---

## What now?

```scala
def login(a: Auth): Future[Either[LoginError, Session]]

def load(u: Session, u: UserId):
  Future[Either[UserError, User]]
```

---

## What now?

```scala
def login(a: Auth): Future[Either[LoginError, Session]]

def load(u: Session, u: UserId):
  Future[Either[UserError, User]]

def run(a: Auth, u: UserId):
  Future[Either[AppError, User]] =

  for {
    s &lt;- login(c)
    b &lt;- s match {
      case Left(e) =>
        Future.ok(e.left)
      case Right(s2) =>
        load(s2, u)
    }
  } yield b
```

---

## Future + Either

```scala
case class FutureE[L, R](run: Future[Either[L, R]]) {






}
```

---

## Future + Either

```scala
case class FutureE[L, R](run: Future[Either[L, R]]) {

  def map(..) = ...

  def flatMap(..) = ...

  def updateError(..) = ...
}
```
---

## Future + Either (take 2)

```scala
case class FutureE[L, R](run: Future[Either[L, R]])


def login(a: Auth): FutureE[LoginError, User]

def load(Session s, u: UserId):
  FutureE[UserError, Session]

def run(a: Auth, u: UserId):
  FutureE[AppError, User] =

  for {
    s &lt;- login(c).updateError(AppLoginError(_))
    b &lt;- load(s, u).updateError(AppUserError(_))
  } yield b
```

---

## EitherT

```scala
case class EitherT[F[_], L, R](run: F[Either[L, R]])
```

---

## EitherT + Future

```scala
case class EitherT[F[_], L, R](run: F[Either[L, R]])


def login(a: Auth): EitherT[Future, LoginError, Session]

def load(Session s, u: UserId):
  EitherT[Future, UserError, User]

def run(a: Auth, u: UserId):
  EitherT[Future, AppError, User] =

  for {
    s &lt;- login(c).updateError(AppLoginError(_))
    b &lt;- load(s, u).updateError(AppUserError(_))
  } yield b
```




























---

template: inverse

# Takeaway

---

template: question

## Partial functions are not functions

---

template: question

## Errors as data

---

## Resources

- _Functional Programming in Scala_ by Paul Chiusano and Rúnar Bjarnason
  - Chapter 4: “Handling errors without exceptions”
- _Designing Fail Fast Error Handling_ by Noel Welsh
  - http://underscore.io/blog/posts/2015/02/23/designing-fail-fast-error-handling.html
- https://github.com/charleso/life-without-stack-traces

    </textarea>
    <link rel="stylesheet" href="js/styles/idea.css">
    <script src="js/remark.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>.
